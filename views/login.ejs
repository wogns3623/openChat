<body>
    <div>
        <form action="" accept-charset="UTF-8" name="user_info" id="user_info">
            <div>
                <label for="user_name">닉네임</label>
                <input type="text" placeholder="ID" name="user_name" id="user_name" />
                <button type="submit">접속하기</button>
            </div>
        </form>
        <p>접속자수 : <span id="visitors"><%=visitors %></span></p>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        $(document).ready(function() {
            
            $("#user_info").submit(function(event) {
                console.log('서버에 로그인정보를 보냅니다!');
                event.preventDefault();
                data = {
                    user_name: $("#user_name").val(),
                    socket_id: socket.id
                }
                socket.emit("login", data);
            });
        
            socket.on('login success', function(userObj) {
                //if(userObj.socket_id != socket.id) return;
                console.log('login success!');

                $.ajax({
                    url: "/saveUserInfo",
                    async: true,
                    type: "POST",
                    data: {
                        socket_id: userObj.socket_id,
                        user_name: userObj.name
                    },
                    dataType: "json",
                    success: function(res) {
                        location.href = "/lobby"
                    },
                });
            });
        
            socket.on("login fail", function(data) {
                //if(data.socket_id != socket.id) return;
                console.log("이름이 같은 유저가 접속중입니다!");
            });

            socket.on("change visitor", function(data) {
                document.getElementById("visitors").innerText = data.visitors;
            });
        });
    </script>
</body>